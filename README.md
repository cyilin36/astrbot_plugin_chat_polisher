# 最终回复润色

在 AI 回复发送给用户之前，调用指定模型提供商对回复文本进行二次润色。

本插件不改变 AstrBot 原本的对话流程，只是在最终发送前对文本做一次“拦截 -> 润色 -> 替换”。

## 功能特性

- 最终润色：只要产生了文本回复，就会在发送前触发润色
- 提供商可选：可在 WebUI 中从 AstrBot 已配置的模型提供商里选择润色模型
- 默认主 AI：未选择提供商时，自动使用当前会话的主 AI（AstrBot 当前配置所使用的模型）
- 提示词可改：在 WebUI 中随时修改润色提示词以切换风格
- 保留富媒体：润色只作用于纯文本组件，图片、At 等消息段会被保留

## 安装

### 方式一：插件市场安装

在 AstrBot WebUI -> 插件管理 的插件市场中搜索“最终回复润色”，点击安装。

### 方式二：手动安装

将插件克隆到 AstrBot 的插件目录（`data/plugins`）下：

```bash
cd AstrBot/data/plugins
git clone https://github.com/cyilin36/astrbot_plugin_chat_polisher.git
```

然后重启 AstrBot，或在 WebUI 的插件管理页面中对该插件执行“重载”。

## 配置

在 AstrBot WebUI -> 插件管理 -> 最终回复润色 中配置。

### 润色使用的模型提供商（`polish_provider`）

- 留空：使用主 AI（当前会话正在使用的模型提供商）
- 选择：使用你在 WebUI 中已配置好的某个模型提供商

### 润色提示词（`polish_prompt`）

- 留空：使用内置的默认润色提示词
- 自定义：直接输入“润色规则/风格要求”，例如：

```text
你是一个文本润色工具，需要去掉所有 Markdown 格式，把文本改写成适合聊天工具发送的口语化风格。
要求：
1) 不要使用列表符号、标题、代码块
2) 保持原意，不添加新信息
3) 输出最终文本，不要解释
```

提示：你不需要关心“原文如何传入模型”，插件会在内部把待润色文本拼接到提示词后面。

### 润色调用超时（`polish_timeout_seconds`）

- 默认：12 秒
- 超过超时时间会触发失败策略

### 润色失败处理方式（`failure_mode`）

- `发送原文（推荐）`：润色失败时发送原始回复（默认）
- `发送失败提示`：润色失败时发送错误提示语

### 润色失败提示语（`failure_message`）

- 仅当上面选择 `发送失败提示` 时生效
- 默认：`润色失败，请检查日志。`

### AI 回复识别标记保留时长（`mark_retention_seconds`）

- 默认：300 秒（5 分钟）
- 该标记只用于插件内部判断“本次回复是否来自 AI 对话流程”
- 超过该时长后会自动失效

### 过期标记检查间隔（`mark_check_interval_seconds`）

- 默认：60 秒（1 分钟）
- 表示系统每隔多久检查一次并删除过期标记
- 建议不要大于上面的“保留时长”

## 实现逻辑

插件通过 AstrBot 的发送前钩子实现强制润色：

1. 在 `on_decorating_result` 阶段拿到即将发送的消息结果（消息链）
2. 插件仅对“经过 AI 对话流程”的回复执行润色；指令触发的回复会跳过
3. 提取消息链中的纯文本（`Plain`）并拼接成待润色文本
4. 根据配置选择润色用的提供商：
   - `polish_provider` 有值：使用该 provider
   - `polish_provider` 为空：回退到当前会话主 AI（`get_using_provider`）
5. 调用 `provider.text_chat()` 请求润色模型（有超时控制）
6. 用润色后的文本替换消息链中的纯文本组件，保留其他组件后发送

关于识别标记：

- 标记只在插件内存中短暂保存，不会写入消息内容
- 正常发送完成后会立即清理；若出现异常未清理，会由周期检查按配置自动回收
- 该机制不会影响 AI 对文本/图片等内容的正常读取

对应代码实现见：`main.py`。

## 注意事项

- 本插件会对所有回复进行二次调用，可能增加延迟与额外 token 消耗。
- 你的回复文本会被发送到你配置的润色模型提供商，请确认隐私合规要求。
- 如果润色模型调用失败或超时，插件会根据配置决定发送原文或错误提示语。

## 版本兼容说明

- 当前代码保留了 `@register` 装饰器注册方式，用于兼容仍依赖装饰器发现机制或插件元数据读取方式的 AstrBot 环境。
- 对于仅面向较新版本 AstrBot 的场景，可评估切换为纯 `Star` 子类自动发现模式。
